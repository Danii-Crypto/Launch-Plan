<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Launch Plan Management Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <style>
        /* ... (existing styles remain unchanged) ... */
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- ... (existing HTML structure remains unchanged) ... -->
    </div>

    <!-- ... (existing modals remain unchanged) ... -->

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA05mM4enMjlOqlAgAfOKcbzWDbmL0ty0M",
            authDomain: "launch-plan-84f8d.firebaseapp.com",
            projectId: "launch-plan-84f8d",
            storageBucket: "launch-plan-84f8d.appspot.com",
            messagingSenderId: "29280389809",
            appId: "1:29280389809:web:78b4debece89b97da5b090",
            measurementId: "G-H2V485X6WN"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Product-specific task templates (unchanged)
        const productTemplates = {
            // ... (existing templates) ...
        };

        // Application state
        let clients = [];
        let currentClient = null;
        let filteredTasks = [];
        let progressChart = null;
        let overallChart = null;
        let showArchived = false;
        let showCompleted = false;
        let unsubscribeClients = null;
        let unsubscribeClientTasks = null;

        // Initialize the application
        async function initializeApp() {
            await setupFirebaseAuth();
            setupEventListeners();
            await loadClients();
            loadClientsDropdown();
            renderClientDashboard();
            renderClientTable();
            updateOverallStats();
            initializeOverallChart();
            initializeReports();
            
            // Set default dates
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            
            document.getElementById('newStartDate').value = today.toISOString().split('T')[0];
            document.getElementById('newLaunchDate').value = nextWeek.toISOString().split('T')[0];
        }

        // Firebase Authentication
        async function setupFirebaseAuth() {
            return new Promise((resolve) => {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        console.log("User signed in:", user.email);
                        resolve();
                    } else {
                        // Sign in anonymously
                        await auth.signInAnonymously();
                        console.log("Signed in anonymously");
                        resolve();
                    }
                });
            });
        }

        // Load clients from Firestore
        async function loadClients() {
            return new Promise((resolve, reject) => {
                unsubscribeClients = db.collection("clients")
                    .where("userId", "==", auth.currentUser.uid)
                    .onSnapshot((snapshot) => {
                        clients = [];
                        snapshot.forEach(doc => {
                            clients.push({ id: doc.id, ...doc.data() });
                        });
                        resolve();
                    }, (error) => {
                        console.error("Error loading clients:", error);
                        reject(error);
                    });
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // ... (existing event listeners remain) ...
            
            // Add new event listener for sign out
            document.getElementById('signOutBtn')?.addEventListener('click', signOut);
        }

        // Save client to Firestore
        async function saveClient(client) {
            try {
                client.userId = auth.currentUser.uid;
                if (client.id) {
                    await db.collection("clients").doc(client.id).set(client);
                } else {
                    const docRef = await db.collection("clients").add(client);
                    client.id = docRef.id;
                }
                return client;
            } catch (error) {
                console.error("Error saving client:", error);
                throw error;
            }
        }

        // Delete client from Firestore
        async function deleteClient(clientId) {
            try {
                await db.collection("clients").doc(clientId).delete();
            } catch (error) {
                console.error("Error deleting client:", error);
                throw error;
            }
        }

        // Save tasks for a client
        async function saveTasks(clientId, tasks) {
            try {
                await db.collection("clients").doc(clientId).update({ tasks });
            } catch (error) {
                console.error("Error saving tasks:", error);
                throw error;
            }
        }

        // Sign out
        function signOut() {
            auth.signOut().then(() => {
                window.location.reload();
            });
        }

        // Modify all data operations to use Firebase:
        // 1. In handleNewClient: replace localStorage with saveClient()
        async function handleNewClient(e) {
            e.preventDefault();
            
            const productType = document.getElementById('newProductType').value;
            const template = JSON.parse(JSON.stringify(productTemplates[productType]));
            
            const newClient = {
                name: document.getElementById('newClientName').value,
                accountNumber: document.getElementById('newAccountNumber').value,
                productType: productType,
                startDate: document.getElementById('newStartDate').value,
                launchDate: document.getElementById('newLaunchDate').value,
                aeName: document.getElementById('newAeName').value,
                csName: document.getElementById('newCSName').value,
                archived: false,
                tasks: template.map(task => ({
                    ...task,
                    id: Date.now() + Math.random().toString(36).substr(2, 9),
                }))
            };
            
            try {
                const savedClient = await saveClient(newClient);
                document.getElementById('newClientModal').classList.add('hidden');
                document.getElementById('newClientForm').reset();
                
                // Auto-select the new client
                document.getElementById('currentClientSelect').value = savedClient.id;
                loadClient(savedClient.id);
            } catch (error) {
                showNotification('Error creating client: ' + error.message, 'error');
            }
        }

        // 2. In saveCurrentClient: replace localStorage with saveClient()
        async function saveCurrentClient() {
            if (!currentClient) return;
            
            const oldStartDate = new Date(currentClient.startDate);
            const oldLaunchDate = new Date(currentClient.launchDate);
            
            currentClient.name = document.getElementById('clientName').value;
            currentClient.accountNumber = document.getElementById('accountNumber').value;
            currentClient.startDate = document.getElementById('startDate').value;
            currentClient.launchDate = document.getElementById('launchDate').value;
            currentClient.aeName = document.getElementById('aeName').value;
            currentClient.csName = document.getElementById('csName').value;
            
            // Sync task dates if project dates changed
            const newStartDate = new Date(currentClient.startDate);
            const newLaunchDate = new Date(currentClient.launchDate);
            
            if (oldStartDate.getTime() !== newStartDate.getTime() || 
                oldLaunchDate.getTime() !== newLaunchDate.getTime()) {
                syncTaskDates(currentClient, newStartDate, newLaunchDate);
            }
            
            try {
                await saveClient(currentClient);
                showNotification('Client information saved and dates synchronized!', 'success');
            } catch (error) {
                showNotification('Error saving client: ' + error.message, 'error');
            }
        }

        // 3. In deleteClient: replace localStorage with deleteClient()
        async function deleteClient(clientId) {
            if (confirm('Are you sure you want to delete this client and all their tasks?')) {
                try {
                    await deleteClient(clientId);
                    
                    if (currentClient && currentClient.id === clientId) {
                        currentClient = null;
                        hideClientSections();
                        document.getElementById('currentClientSelect').value = '';
                    }
                } catch (error) {
                    showNotification('Error deleting client: ' + error.message, 'error');
                }
            }
        }

        // 4. In updateTaskStatus: replace localStorage with saveTasks()
        async function updateTaskStatus(taskId, newStatus) {
            const task = currentClient.tasks.find(t => t.id == taskId);
            if (task) {
                task.status = newStatus;
                try {
                    await saveTasks(currentClient.id, currentClient.tasks);
                } catch (error) {
                    showNotification('Error updating task: ' + error.message, 'error');
                }
            }
        }

        // 5. In deleteTask: replace localStorage with saveTasks()
        async function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                currentClient.tasks = currentClient.tasks.filter(t => t.id != taskId);
                try {
                    await saveTasks(currentClient.id, currentClient.tasks);
                    applyFilters();
                } catch (error) {
                    showNotification('Error deleting task: ' + error.message, 'error');
                }
            }
        }

        // 6. In handleAddTask: replace localStorage with saveTasks()
        async function handleAddTask(e) {
            e.preventDefault();
            
            if (!currentClient) return;
            
            const taskData = {
                id: Date.now() + Math.random().toString(36).substr(2, 9),
                environment: document.getElementById('newTaskEnvironment').value,
                task: document.getElementById('newTaskDescription').value,
                owner: document.getElementById('newTaskOwner').value,
                priority: document.getElementById('newTaskPriority').value,
                status: 'To do',
                startDate: document.getElementById('newTaskStartDate').value,
                dueDate: calculateDueDate(
                    document.getElementById('newTaskStartDate').value, 
                    document.getElementById('newTaskDuration').value
                ),
                duration: parseInt(document.getElementById('newTaskDuration').value),
                delay: 0
            };
            
            currentClient.tasks.push(taskData);
            
            try {
                await saveTasks(currentClient.id, currentClient.tasks);
                document.getElementById('addTaskModal').classList.add('hidden');
                document.getElementById('addTaskForm').reset();
            } catch (error) {
                showNotification('Error adding task: ' + error.message, 'error');
            }
        }

        // 7. In toggleClientArchive: replace localStorage with saveClient()
        async function toggleClientArchive(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (client) {
                client.archived = !client.archived;
                try {
                    await saveClient(client);
                    const action = client.archived ? 'archived' : 'unarchived';
                    showNotification(`Client ${client.name} ${action} successfully!`, 'success');
                } catch (error) {
                    showNotification('Error updating client: ' + error.message, 'error');
                }
            }
        }

        // ... (rest of the code remains similar, but remove all localStorage references) ...

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
